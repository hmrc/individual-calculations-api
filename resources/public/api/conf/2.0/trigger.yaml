tags:
  - Self Assessment
description: |
  This endpoint allows the user to trigger a self-assessment tax calculation for a given tax year.
  It should be called whenever income data is updated through a periodic or annual endpoint. 
  The tax calculation can take up to 5 seconds to process. 
  We recommend you wait 5 seconds before calling retrieval endpoints. 
  The result of the calculation can be seen using the 
  “Retrieve Self Assessment Tax Calculation Metadata” endpoint.
  
  ### Test data 
  Scenario simulations using `Gov-Test-Scenario` headers is only available in the sandbox environment.
  
  | Header Value (Gov-Test-Scenario)   | Scenario                                                                                           |
  |------------------------------------|----------------------------------------------------------------------------------------------------|
  | N/A - DEFAULT                      | Simulates a successful response                                                                    |
  | NO_INCOME_SUBMISSIONS_EXIST        | Simulates the scenario where no income submissions exist for the tax year                         |


parameters:
  - $ref: ./common/pathParameters.yaml#/components/parameters/nino
  - $ref: ./common/headers.yaml#/components/parameters/acceptJson
  - $ref: ./common/headers.yaml#/components/parameters/contentTypeJson
  - $ref: ./common/headers.yaml#/components/parameters/authorizationWriteScopeHeader
  - $ref: ./common/headers.yaml#/components/parameters/testScenarioHeader

requestBody:
  content:
    application/json:
      schema:
        $ref: ./schemas/selfAssessment/trigger/trigger.json
      examples:
        example-1:
          description: Default Example
          value:
            $ref: ./examples/selfAssessment/trigger/trigger.json

responses:
  200:
    description: Success
    headers:
      X-CorrelationId:
        $ref: ./common/headers.yaml#/components/parameters/correlationId
    content:
      application/json:
        schema:
          $ref: ./schemas/crystallisation/crystallise_request.json
        examples:
          example-1:
            value:
              $ref: ./examples/crystallisation/crystallisation_request.json

  400:
    description: Bad request
    content:
      application/json:
        schema:
          $ref: ./schemas/error-response.yaml
        examples:
          FORMAT_NINO:
            $ref: ./common/errors.yaml#/components/examples/formatNino
          FORMAT_TAX_YEAR:
            $ref: ./common/errors.yaml#/components/examples/formatTaxYear
          RULE_TAX_YEAR_NOT_SUPPORTED:
            $ref: ./common/errors.yaml#/components/examples/ruleTaxYearNotSupported
          RULE_TAX_YEAR_RANGE_INVALID:
            $ref: ./common/errors.yaml#/components/examples/ruleTaxYearRangeInvalid
          RULE_INCORRECT_OR_EMPTY_BODY_SUBMITTED:
            $ref: ./common/errors.yaml#/components/examples/incorrectOrEmptyBody
          RULE_INCORRECT_GOV_TEST_SCENARIO:
            $ref: ./common/errors.yaml#/components/examples/ruleIncorrectGTS

  403:
    description: Forbidden
    content:
      application/json:
        schema:
          $ref: ./schemas/error-response.yaml
        examples:
          CLIENT_OR_AGENT_NOT_AUTHORISED:
            $ref: ./common/errors.yaml#/components/examples/clientOrAgentNotAuthorised
          RULE_NO_INCOME_SUBMISSIONS_EXIST:
            $ref: ./common/errors.yaml#/components/examples/ruleNoIncomeSubmissionsExists
